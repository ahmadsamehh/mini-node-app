name: SSM Docker Run (polling)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  ssm-test:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Send SSM command
        id: send
        shell: bash
        run: |
          set -euo pipefail

          CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "${{ secrets.SSM_INSTANCE_ID }}" \
            --parameters commands='[
              "set -e",
              "cd mini-node-app || exit 1",
              "docker container rm -f zebby >/dev/null 2>&1 || true",
              "docker compose pull -d",
              "docker compose up -d",
              "sleep 2",
              "docker ps --filter name=bf-gf-container --format \"{{.Names}}: {{.Status}}\"",
            ]' \
            --query "Command.CommandId" \
            --output text)

          echo "command_id=$CMD_ID" >> "$GITHUB_OUTPUT"
          echo "SSM CommandId: $CMD_ID"

      - name: Wait for SSM completion and print output
        shell: bash
        run: |
          set -euo pipefail

          CMD_ID="${{ steps.send.outputs.command_id }}"
          INSTANCE_ID="${{ secrets.SSM_INSTANCE_ID }}"

          echo "Waiting for SSM command to finish..."
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$CMD_ID" \
              --instance-id "$INSTANCE_ID" \
              --query "Status" \
              --output text)

            echo "Status: $STATUS"

            if [[ "$STATUS" == "Success" ]]; then
              aws ssm get-command-invocation \
                --command-id "$CMD_ID" \
                --instance-id "$INSTANCE_ID" \
                --query 'StandardOutputContent' \
                --output text
              exit 0
            fi

            if [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" || "$STATUS" == "TimedOut" ]]; then
              echo "SSM command failed. Full invocation details:"
              aws ssm get-command-invocation \
                --command-id "$CMD_ID" \
                --instance-id "$INSTANCE_ID"
              exit 1
            fi

            sleep 2
          done

          echo "Timed out waiting for SSM command."
          exit 1
